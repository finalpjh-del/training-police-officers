<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ëª…ì˜ˆâ€¢ì¶”ëª¨ê´€ â€” ê²½ì°° ì–‘ì„±</title>
<style>
  :root{ --bg1:#0ea5e9; --bg2:#6366f1; --ink:#111; --paper:#fff; }
  *{box-sizing:border-box}
  body{margin:0;font-family:Arial,system-ui,sans-serif;color:#fff;background:linear-gradient(90deg,var(--bg1),var(--bg2))}
  header{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;padding:14px}
  .pill{background:#0b1020;color:#fff;border-radius:999px;padding:8px 12px;text-decoration:none}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .controls input,.controls select{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.35);background:rgba(255,255,255,.15);color:#fff;outline:none}
  .controls input::placeholder{color:rgba(255,255,255,.85)}
  h2.section{margin:18px 14px 8px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px;padding: 8px 14px 20px}
  .card{border-radius:16px;overflow:hidden;box-shadow:0 16px 40px rgba(0,0,0,.22);transform:translateY(6px);
        transition:transform .2s ease, box-shadow .2s ease, opacity .3s ease; opacity:.98}
  .card:hover{transform:translateY(2px);box-shadow:0 18px 52px rgba(0,0,0,.28)}
  .top{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:rgba(0,0,0,.12)}
  .chip{padding:4px 8px;border-radius:999px;font-weight:800;background:#fff;color:#111}
  .content{padding:12px}
  .avatar{width:48px;height:48px;border-radius:50%;object-fit:cover;box-shadow:0 2px 8px rgba(0,0,0,.25);margin-right:8px}
  .meta{font-size:13px;opacity:.92}
  .name{font-size:18px;font-weight:900}
  .gold{color:#fff2a8;font-weight:900}
  .splitter{height:1px;background:linear-gradient(90deg,rgba(255,255,255,.6),rgba(255,255,255,.08));margin:8px 0}
  .secwrap{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);border-radius:14px;margin:10px 14px;padding:6px 0}
  .saveCard{margin-top:8px;padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:800;background:#0b1020;color:#fff}
.banner{margin:10px 14px;padding:14px;border-radius:16px;
  background:linear-gradient(135deg,rgba(255,255,255,.22),rgba(255,255,255,.08));
  border:1px solid rgba(255,255,255,.35);box-shadow:0 10px 28px rgba(0,0,0,.18)}
.banner h2{margin:0 0 6px}
.banner p{margin:0;opacity:.95}
.ribbon{margin:10px 14px;padding:12px;border-radius:12px;background:linear-gradient(90deg,#22c55e,#16a34a);font-weight:900;box-shadow:0 10px 28px rgba(0,0,0,.18)}
.ribbon small{opacity:.9;font-weight:700}
.copy{cursor:pointer;text-decoration:underline}
</style>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
<header>
  <h1 style="margin:0">ğŸ•¯ï¸ ëª…ì˜ˆâ€¢ì¶”ëª¨ê´€</h1>
  <nav class="controls">
    <a class="pill" href="index.html">ë©”ì¸ìœ¼ë¡œ</a>
    <a class="pill" href="police_training_game.html">ê²Œì„í•˜ê¸°</a>
  </nav>
  <div class="controls">
    <input id="search" type="text" placeholder="ì´ë¦„Â·ì¡°ì§Â·ê³„ê¸‰ ê²€ìƒ‰">
    <select id="sort">
      <option value="new">ğŸ•“ ìµœì‹ ìˆœ</option>
      <option value="old">ğŸ“œ ì˜¤ë˜ëœìˆœ</option>
      <option value="rank">ğŸ–ï¸ ê³„ê¸‰ìˆœ</option>
      <option value="name">ğŸ”¤ ì´ë¦„ìˆœ</option>
      <option value="months">ğŸ“… ê·¼ë¬´ê¸°ê°„ìˆœ</option>
    </select>
  </div>
</header>

<div class="banner"><h2>ìš°ë¦¬ëŠ” ê¸°ì–µí•©ë‹ˆë‹¤.</h2><p>ë‹¹ì‹ ì˜ í—Œì‹ ê³¼ ìš©ê¸°ë¥¼ ìŠì§€ ì•ŠìŠµë‹ˆë‹¤. ê¸°ë¡ì€ ëª…ì˜ˆê°€ ë©ë‹ˆë‹¤.</p></div>
<div id="achv"></div>
<div id="wrap"></div>

<script>
(()=>{
  const SKEY="police_memorials";
  const $=id=>document.getElementById(id);
  const wrap=$("wrap");
  const achv=$("achv");

  const groups=[
    {key:"ìˆœì§",               title:"ğŸª¦ ìˆœì§",                colors:["#b22222","#ff6b6b"]},
    {key:"ëª…ì˜ˆí‡´ì§-ì²­ì¥í‡´ì§",  title:"ğŸ… ëª…ì˜ˆí‡´ì§-ì²­ì¥í‡´ì§",  colors:["#ffd700","#ffb347"]},
    {key:"ì •ë…„í‡´ì§",           title:"ğŸ–ï¸ ì •ë…„í‡´ì§",            colors:["#007bff","#00c6ff"]},
    {key:"ì¶”ë°©",               title:"ğŸš« ì¶”ë°©",                 colors:["#6c757d","#adb5bd"]},
    {key:"ì˜ì›ë©´ì§-í™”ì´ì–´ì¡±",  title:"ğŸ“ ì˜ì›ë©´ì§-í™”ì´ì–´ì¡±",  colors:["#8e2de2","#4a00e0"]},
  ];

  const RANKS = ["ì˜ê²½","ìˆœê²½","ê²½ì¥","ê²½ì‚¬","ê²½ìœ„","ê²½ê°","ê²½ì •","ì´ê²½","ê²½ë¬´ê´€","ì¹˜ì•ˆê°","ì¹˜ì•ˆì •ê°","ì¹˜ì•ˆì´ê°"];
  const rankIndex = (r)=>{
    const i = RANKS.indexOf(r||"");
    return i>=0? i : -1;
  };

  function hasAllEndings(data){
      const need = ["ìˆœì§","ëª…ì˜ˆí‡´ì§-ì²­ì¥í‡´ì§","ì •ë…„í‡´ì§","ì¶”ë°©","ì˜ì›ë©´ì§-í™”ì´ì–´ì¡±"];
      const done = new Set((data||[]).map(x=>x.endTitle||""));
      return need.every(k=> Array.from(done).some(t=> t.includes(k)));
    }
    function draw(){
    const q=($("search").value||"").trim();
    const sort=($("sort").value||"new");
    const data=JSON.parse(localStorage.getItem(SKEY)||"[]");

    wrap.innerHTML="";
    achv.innerHTML="";
    if(!data.length){ wrap.innerHTML=`<div class="secwrap" style="padding:18px;text-align:center">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ê²Œì„ì—ì„œ ì—”ë”©ì„ ë³¸ ë’¤ ìë™ ì €ì¥ë©ë‹ˆë‹¤.</div>`; return; }

    if(hasAllEndings(data)){
      achv.innerHTML = `<div class="ribbon">ğŸ‰ ë‹¹ì‹ ì€ ëª¨ë“  ì—…ì ì„ ë‹¬ì„±í•˜ì˜€ìŠµë‹ˆë‹¤. <small>(ìˆœì§Â·ëª…ì˜ˆí‡´ì§Â·ì •ë…„í‡´ì§Â·ì¶”ë°©Â·ì˜ì›ë©´ì§)</small><br>ğŸ“« ë¬¸ì˜: <span id='mailto' class='copy'>finalpjh@gmail.com</span></div>`;
      // Copy-to-clipboard
      setTimeout(()=>{
        const m=document.getElementById('mailto');
        if(m){ m.onclick=()=>{ navigator.clipboard?.writeText('finalpjh@gmail.com'); m.textContent='ë³µì‚¬ë¨: finalpjh@gmail.com'; setTimeout(()=>m.textContent='finalpjh@gmail.com',1600); }; }
      }, 0);
    }

    let items=data.slice();
    if(q) items=items.filter(x=> (x.name||"").includes(q) || (x.org||"").includes(q) || (x.currentRank||"").includes(q) || (x.entryRank||"").includes(q) || (x.endTitle||"").includes(q));

    const sortFn = (list)=>{
      if(sort==="new") list.sort((a,b)=>(b.id||0)-(a.id||0));
      else if(sort==="old") list.sort((a,b)=>(a.id||0)-(b.id||0));
      else if(sort==="months") list.sort((a,b)=>(b.months||0)-(a.months||0));
      else if(sort==="name") list.sort((a,b)=> (a.name||"").localeCompare(b.name||"","ko"));
      else if(sort==="rank") list.sort((a,b)=> (rankIndex(b.currentRank)-rankIndex(a.currentRank))); // ë†’ì€ ê³„ê¸‰ ìš°ì„ 
      else list.sort((a,b)=>(b.id||0)-(a.id||0)); // ê¸°ë³¸: ìµœì‹ 
    };

    groups.forEach(g=>{
      const sect=items.filter(x=>(x.endTitle||"").includes(g.key));
      if(!sect.length) return;
      sortFn(sect);

      const sec=document.createElement("section");
      sec.className="secwrap";
      sec.innerHTML=`<h2 class="section">${g.title}</h2><div class="grid"></div>`;
      wrap.appendChild(sec);
      const grid=sec.querySelector(".grid");

      sect.forEach(it=>{
        const y=Math.floor((it.months||0)/12), m=(it.months||0)%12;
        const startStr=new Date(it.startDate||Date.now()).toLocaleDateString('ko-KR',{year:'numeric',month:'long',day:'numeric'});
        const kills=Object.keys(it.defeated||{}).map(k=>`${k}: ${it.defeated[k]}ëª…`).join(", ") || "ì—†ìŒ";
        const hist=(it.changeLog||[]).join(" / ") || "ì—†ìŒ";
        const goldLine = (it.finalGold!=null) ? `<div class="meta">ë§ˆì§€ë§‰ ë³´ìœ  ê³¨ë“œ : ${it.finalGold}</div>` : "";

        const card=document.createElement("article");
        card.className="card";
        card.style.background=`linear-gradient(135deg, ${g.colors[0]}, ${g.colors[1]})`;
        card.innerHTML=`
          <div class="top">
            <img class="avatar" onerror="this.style.display='none'" src="" alt="avatar">
            <span class="chip">${it.endTitle||"ì—”ë”©"}</span>
          </div>
          <div class="content">
            <div class="name">${it.name}</div>
            <div class="meta">${it.org} <span class="gold">${it.entryRank}</span> â†’ í˜„ì¬ <span class="gold">${it.currentRank}</span></div>
            <div class="meta">ì…ì‚¬ : ${startStr}</div>
            <div class="meta">ê·¼ë¬´ê¸°ê°„ : ${String(y).padStart(2,'0')}ë…„ ${String(m).padStart(2,'0')}ê°œì›”</div>
            ${goldLine}
            <div class="splitter"></div>
            <div class="meta">ì œì•• ëª©ë¡: ${kills}</div>
            <div class="meta">ìŠ¹ì§„/ê°•ë“±: ${hist}</div>
          </div>
        `;
        const saveBtn=document.createElement("button");
        saveBtn.className="saveCard";
        saveBtn.textContent="ğŸ“¸ ì¹´ë“œ JPG ì €ì¥";
        card.querySelector(".content").appendChild(saveBtn);
        
        // Set avatar (seeded by name)
        const name = it.name || 'hero';
        const ava = card.querySelector('.avatar');
        if(ava){ ava.src = `https://i.pravatar.cc/160?u=${encodeURIComponent(name)}`; }
                grid.appendChild(card);
      });
    });
  }

  ["search","sort"].forEach(id=>$(id).addEventListener("input",draw));
  draw();

  // ì´ë¯¸ì§€ ì €ì¥ ê¸°ëŠ¥
  document.addEventListener('click', (e)=>{
    if(e.target && e.target.classList.contains('saveCard')){
      const card = e.target.closest('.card');
      if(!card) return;
      html2canvas(card, {backgroundColor: null, scale: 2, ignoreElements: el => el && el.classList && el.classList.contains('saveCard') }).then(canvas=>{
        const link = document.createElement('a');
        link.download = `memorial_${Date.now()}.jpg`;
        link.href = canvas.toDataURL('image/jpeg', 0.95);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }).catch(err=>console.warn('saveCard failed', err));
    }
  });
})();
</script>
</body>
</html>
