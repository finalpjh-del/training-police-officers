<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ê²½ì°° ì–‘ì„± ê²Œì„</title>
<style>
  :root{--bg1:#ff9966;--bg2:#ff5e62;--ink:#10131a;--paper:#fff;--dark:#111}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(90deg,var(--bg1),var(--bg2));color:#fff;
       font-family:Arial,system-ui,sans-serif;text-align:center}
  h1{margin:12px 0 6px}
  button{border:0;padding:12px 16px;margin:6px;border-radius:14px;font-size:15px;cursor:pointer;
         transform:translateY(0);transition:transform .12s ease, filter .2s ease}
  button:hover{transform:translateY(-1px);filter:brightness(1.05)}
  button:disabled{opacity:.5;cursor:not-allowed}
  .ok{background:linear-gradient(90deg,#ff9966,#ff5e62);color:#fff;font-weight:800;box-shadow:0 6px 18px rgba(0,0,0,.25)}
  .ghost{opacity:.7}
  .bar{display:flex;align-items:center;justify-content:space-between;padding:8px 10px}
  .pill{background:#0b1020;color:#fff;border-radius:999px;padding:8px 12px;font-weight:700;text-decoration:none}
  .hud{margin:6px 0 2px}
  #pDice,#eDice{font-size:92px;display:inline-block}
  .shake{animation:shake .3s ease}
  @keyframes shake{
    0%{transform:translate(-2px,0) scale(1) rotate(0deg)}
    25%{transform:translate(8px,-6px) scale(1.3) rotate(20deg)}
    50%{transform:translate(-10px,4px) scale(0.9) rotate(-25deg)}
    75%{transform:translate(6px,-8px) scale(1.25) rotate(18deg)}
    100%{transform:translate(0,0) scale(1) rotate(0deg)}
  }
  .pop-enter{animation:pop .25s ease both}
  @keyframes pop{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}
  .flex{display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:14px;z-index:1000}
  .modal{width:min(92vw,640px);background:var(--paper);color:var(--ink);border-radius:18px;padding:20px;
         box-shadow:0 18px 50px rgba(0,0,0,.35)}
  .seg{display:inline-flex;border:1px solid rgba(0,0,0,.12);border-radius:12px;overflow:hidden}
  .seg button{background:#f3f6fb;color:#111}
  .seg button.selected{background:#111;color:#fff;font-weight:800}
  .titlechip{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:12px;color:#fff;
             background:linear-gradient(90deg,#ff9966,#ff5e62);font-weight:800;box-shadow:0 2px 10px rgba(255,120,90,.4)}
  #ending{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;color:#fff;z-index:1200}
  #ending .panel{width:min(92vw,780px);background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);
                 border-radius:18px;padding:22px;text-align:left}
  #ending h2{margin:0 0 10px}
  #ending ul{list-style:none;padding:0;margin:8px 0 10px}
  #ending li{margin:6px 0}
  .sec{display:flex;align-items:center;gap:10px;margin:14px 0 8px}
  .sec .chip{padding:6px 12px;border-radius:999px;background:linear-gradient(90deg,#fff,#ffe4d6);color:#111;font-weight:800}
  .sec .line{height:1px;background:linear-gradient(90deg,rgba(255,255,255,.7),rgba(255,255,255,.1));flex:1}
  .cta{text-align:center;margin-top:10px}
  .small{font-size:13px;opacity:.9}
  input[type="text"]{padding:10px 12px;border-radius:12px;border:1px solid #ddd;width:100%;max-width:280px}
</style>
</head>
<body>
  <h1 class="pop-enter">ğŸ² ê²½ì°° ì–‘ì„± ğŸ²</h1>

  <div id="start" class="overlay" style="display:flex">
    <div class="modal pop-enter">
      <div class="titlechip">ğŸªª ì‹ ì› ì„ íƒ</div>
      <div style="height:8px"></div>
      <div>ì¡°ì§</div>
      <div class="seg" role="group">
        <button id="orgPolice">ğŸš“ ê²½ì°°</button>
        <button id="orgCoast">ğŸš¤ í•´ì–‘ê²½ì°°</button>
      </div>
      <div style="height:10px"></div>
      <div>ì„±ë³„</div>
      <div class="seg" role="group">
        <button id="genderM">ğŸ‘¨ ë‚¨ì</button>
        <button id="genderF">ğŸ‘© ì—¬ì</button>
      </div>
      <div style="height:10px"></div>
      <div>ì‹œì‘ ê³„ê¸‰</div>
      <div class="seg" role="group">
        <button id="rankStartA">ìˆœê²½</button>
        <button id="rankStartB">ê²½ìœ„</button>
      </div>
      <div style="height:10px"></div>
      <div class="flex">
        <label for="nm">ì´ë¦„</label>
        <input id="nm" type="text" placeholder="ë¹„ì›Œë‘ë©´ ê¸°ë³¸ ì´ë¦„ ì ìš©" />
      </div>
      <div class="flex" style="justify-content:flex-end">
        <button id="btnStart" class="ok">ì‹œì‘</button>
      </div>
    </div>
  </div>

  <div id="game" style="display:none">
    <div class="bar">
      <a class="pill" href="index.html">â¬…ï¸ ë’¤ë¡œ</a>
      <span id="orgBadge" class="pill">ğŸš“ ê²½ì°°</span>
    </div>
    <div class="hud">
      <span id="emoji">ğŸ‘®</span>
      <span id="rank">ìˆœê²½</span>
      <span id="name">â€”</span>
      | â¤ï¸ <span id="hp">50</span>/<span id="maxhp">50</span>
      | ğŸ’° <span id="gold">0</span>
      | ğŸ’‰ êµ¬ê¸‰í•¨ <span id="bags">0</span>
    </div>
    <div>âš”ï¸ ì : <span id="enemyName"></span> (ì²´ë ¥: <span id="enemyHP"></span>)</div>
    <div style="margin-top:6px">
      <button id="btnRoll" class="ok">ğŸ² êµ´ë¦¬ê¸°</button>
      <button id="btnFire" class="ok">ğŸ”« ê²©ë°œ (-3ğŸ’°)</button>
    </div>
    <div class="flex" style="margin:6px 0">
      ë‚˜: <span id="pDice">ğŸ²</span> ì : <span id="eDice">ğŸ²</span>
    </div>
    <div id="msg" class="small">âš”ï¸ ì œì•• ì¤‘...</div>

    <div id="after" style="display:none">
      <div class="flex">
        <button id="btnRest">ğŸ›€ğŸ¼ ì”»ê³  ì¶œê·¼ (â¤ï¸5)</button>
        <button id="btnBuyBag">ğŸ’‰ êµ¬ê¸‰í•¨ (5ğŸ’°)</button>
        <button id="btnPromote">ğŸ–ï¸ ìŠ¹ì§„ (<span id="cost">10</span>ğŸ’°)</button>
        <button id="btnAmmo" class="ok">ğŸ”„ ë‹¤ìŒ í„´ íƒ„ì¢…: 9mm</button>
      </div>
    </div>

    <div style="margin-top:6px">
      <button id="btnUseBag">ğŸ’‰â¤ï¸30</button>
      <button id="btnRestart" class="ghost" style="display:none">ğŸ”„ ì¬ì‹œì‘</button>
    </div>
  </div>

  <div id="pop" class="overlay">
    <div class="modal pop-enter">
      <div id="popTitle" class="titlechip">ì•Œë¦¼</div>
      <ul id="popList" style="list-style:none; padding:0; margin:10px 0"></ul>
      <div class="flex" style="justify-content:flex-end">
        <button id="popOk" class="ok">í™•ì¸</button>
      </div>
    </div>
  </div>

  <div id="ending">
    <div class="panel pop-enter">
      <h2 id="endTitle">ì—”ë”©</h2>
      <ul id="endList"></ul>
      <div class="sec"><span class="chip">ìŠ¹ì§„/ê°•ë“± ì´ë ¥</span><span class="line"></span></div>
      <ul id="hist"></ul>
      <div class="sec"><span class="chip">ì œì•• ëª©ë¡</span><span class="line"></span></div>
      <ul id="kill"></ul>
      <div class="small">ì—”ë”© ë‚´ìš©ì´ ëª…ì˜ˆâ€¢ì¶”ëª¨ê´€ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
      <div class="cta">
        <button id="endExit" class="ok" disabled>ë‚˜ê°€ê¸°</button>
        <a id="gotoGallery" href="honor_memorial.html" class="pill" style="text-decoration:none">ëª…ì˜ˆâ€¢ì¶”ëª¨ê´€ ì—´ê¸°</a>
      </div>
    </div>
  </div>

<script>
(()=>{
  const $ = id => document.getElementById(id);
  const RANKS = ["ì˜ê²½","ìˆœê²½","ê²½ì¥","ê²½ì‚¬","ê²½ìœ„","ê²½ê°","ê²½ì •","ì´ê²½","ê²½ë¬´ê´€","ì¹˜ì•ˆê°","ì¹˜ì•ˆì •ê°","ì¹˜ì•ˆì´ê°"];
  const DICE = ['âš€','âš','âš‚','âšƒ','âš„','âš…'];
  const ENEMIES = {1:["ğŸ§Ÿâ€â™‚ï¸ ì£¼ì·¨ì","ğŸ¦¹â€â™‚ï¸ ë³´ì´ìŠ¤í”¼ì‹±"],2:["ğŸ¤¹â€â™‚ï¸ ì‚¬ê¸°ê¾¼","ğŸ‘¨â€ğŸ’» ìŠ¤í† ì»¤"],3:["ğŸ§Œ ì¡°í­","ğŸ’Š ë§ˆì•½ì‚¬ë²”"],4:["ğŸ‘¤ ê°„ì²©","ğŸª– í…ŒëŸ¬ë¦¬ìŠ¤íŠ¸"],5:["ğŸ‘¨â€âœˆï¸ ë¶€íŒ¨í•œ ê²½ì°°","ğŸ—£ï¸ ë‚´ë€ ìš°ë‘ë¨¸ë¦¬"]};
  const MAX_LEVEL = 99;

  const el = {
    start:$("start"), game:$("game"), pop:$("pop"), popTitle:$("popTitle"), popList:$("popList"), popOk:$("popOk"),
    btnStart:$("btnStart"), nm:$("nm"), orgPolice:$("orgPolice"), orgCoast:$("orgCoast"),
    genderM:$("genderM"), genderF:$("genderF"), rankStartA:$("rankStartA"), rankStartB:$("rankStartB"),
    orgBadge:$("orgBadge"), emoji:$("emoji"), rank:$("rank"), name:$("name"),
    hp:$("hp"), maxhp:$("maxhp"), gold:$("gold"), bags:$("bags"),
    enemyName:$("enemyName"), enemyHP:$("enemyHP"), btnRoll:$("btnRoll"), btnFire:$("btnFire"),
    pDice:$("pDice"), eDice:$("eDice"), msg:$("msg"),
    after:$("after"), btnRest:$("btnRest"), btnBuyBag:$("btnBuyBag"), btnPromote:$("btnPromote"), cost:$("cost"), btnUseBag:$("btnUseBag"),
    btnRestart:$("btnRestart"), btnAmmo:$("btnAmmo"),
    ending:$("ending"), endExit:$("endExit"), endTitle:$("endTitle"), endList:$("endList"), hist:$("hist"), kill:$("kill")
  };

  const state = {
    org:null, gender:null, name:"â€”",
    startRankIdx:1, rankIdx:1, entryRank:"ìˆœê²½",
    level:1, maxHP:50, hp:50, gold:0, bags:0,
    enemyHP:0, enemyLabel:"", cost:10,
    ended:false, startDate:new Date(),
    defeated:{}, bonusMonths:0, rankStartMonths:0, changeLog:[],
    monthsAccum:0, finalGold:0,
    equalStreak:0,
    ammo:'22lr'
  };

  const rint=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const emojiByGender=()=> state.gender==='F'?'ğŸ‘®â€â™€ï¸':(state.gender==='M'?'ğŸ‘®â€â™‚ï¸':'ğŸ‘®');
  const orgName=()=> state.org==='coast'?'í•´ì–‘ê²½ì°°':'ê²½ì°°';
  const enemyTier=lv=> lv<=10?1:lv<=25?2:lv<=45?3:lv<=70?4:5;
  const setBtns=on=>{ el.btnRoll.disabled=!on; el.btnFire.disabled=!on; };
  const updateFireLabel=()=>{ el.btnFire.textContent = (state.ammo==='9mm') ? "ğŸ”« ê²©ë°œ (-4ğŸ’°)" : "ğŸ”« ê²©ë°œ (-3ğŸ’°)"; };
  const updateHUD=()=>{
    el.orgBadge.textContent=(state.org==='coast'?'ğŸš¤ í•´ì–‘ê²½ì°°':'ğŸš“ ê²½ì°°');
    el.emoji.textContent=state.gender==='F'?'ğŸ‘®â€â™€ï¸':(state.gender==='M'?'ğŸ‘®â€â™‚ï¸':'ğŸ‘®');
    el.rank.textContent=RANKS[state.rankIdx];
    el.name.textContent=state.name;
    el.hp.textContent=state.hp;
    el.maxhp.textContent=state.maxHP;
    el.gold.textContent=state.gold;
    el.bags.textContent=state.bags;
    el.enemyName.textContent=state.enemyLabel;
    el.enemyHP.textContent=state.enemyHP;
    el.cost.textContent=state.cost;
    updateFireLabel();
  };
  const openPopup=(title,lines)=>{ el.popTitle.textContent=title; el.popList.innerHTML=(Array.isArray(lines)?lines:[lines]).map(x=>`<li>${x}</li>`).join(""); el.pop.style.display="flex"; setTimeout(()=>el.popOk.focus(),10); };
  const closePopup=()=> el.pop.style.display="none";
  el.popOk.onclick=closePopup; el.pop.onclick=e=>{ if(e.target===el.pop) closePopup(); };

  const pickEnemy=()=>{ const t=enemyTier(state.level); const list=ENEMIES[t]; const name=list[rint(0,list.length-1)]; state.enemyLabel=`Lv.${state.level} ${name}`; state.enemyHP=9+state.level*1; };
  const spawnEnemy=()=>{ el.after.style.display="none"; pickEnemy(); updateHUD(); setBtns(true); el.msg.textContent="âš”ï¸ ì œì•• ì¤‘..."; el.pDice.textContent="ğŸ²"; el.eDice.textContent="ğŸ²"; state.equalStreak=0; };

  const perKillMonths=()=> (state.rankIdx>=2 && state.rankIdx<=6)?6:3;
  const rankBonusMonths=idx=> idx<=3?5:(idx<=7?11:5);
  const totalMonths=()=> state.monthsAccum + state.bonusMonths;

  function bonusByLevel(lv){
    if(lv>=90) return 12;
    if(lv>=80) return 10;
    if(lv>=70) return 8;
    if(lv>=60) return 6;
    if(lv>=50) return 4;
    if(lv>=40) return 2;
    if(lv>=30) return 1;
    return 0;
  }

  function checkResignByWealth(){
    if(!state.ended && state.gold>=1000){
      state.ended=true;
      state.finalGold = state.gold;
      openEnding("ì˜ì›ë©´ì§-í™”ì´ì–´ì¡±");
      return true;
    }
    return false;
  }

  function grantGold(){
    let earn=0;
    if(state.level<=10) earn=2; else if(state.level<=25) earn=4; else if(state.level<=45) earn=8; else if(state.level<=70) earn=16; else earn=32;
    if(state.rankIdx>0) earn+=state.rankIdx;
    earn += bonusByLevel(state.level);
    state.gold+=earn; updateHUD(); checkResignByWealth(); return earn;
  }
  const addDefeated=()=>{ const pure=state.enemyLabel.replace(/Lv\.\d+\s+/,''); state.defeated[pure]=(state.defeated[pure]||0)+1; };

  function saveMemorial(endTitle){
    try{
      const entry = {
        id: Date.now(),
        endTitle,
        name: state.name,
        org: orgName(),
        entryRank: state.entryRank,
        currentRank: RANKS[state.rankIdx],
        startDate: state.startDate,
        months: totalMonths(),
        level: state.level,
        defeated: state.defeated,
        changeLog: state.changeLog,
        finalGold: state.finalGold || state.gold || 0
      };
      const arr = JSON.parse(localStorage.getItem("police_memorials")||"[]");
      arr.push(entry);
      localStorage.setItem("police_memorials", JSON.stringify(arr));
    }catch(e){ console.warn("saveMemorial failed", e); }
  }

  function openEnding(title){
    el.endTitle.textContent = title;
    const mAll=totalMonths(), y=Math.floor(mAll/12), m=mAll%12;
    const startStr = new Date(state.startDate).toLocaleDateString('ko-KR',{year:'numeric',month:'long',day:'numeric'});
    const lastGold = state.finalGold || state.gold || 0;
    el.endList.innerHTML=[
      `ì…ì‚¬ : ${startStr} ${orgName()} ${state.entryRank}`,
      `í˜„ì¬ ê³„ê¸‰ : ${RANKS[state.rankIdx]}`,
      `ê·¼ë¬´ê¸°ê°„ : ${String(y).padStart(2,'0')}ë…„ ${String(m).padStart(2,'0')}ê°œì›”`,
      `ë§ˆì§€ë§‰ ë³´ìœ  ê³¨ë“œ : ${lastGold}`
    ].map(s=>`<li>${s}</li>`).join("");
    el.hist.innerHTML = state.changeLog.length? state.changeLog.map(s=>`<li>â€¢ ${s}</li>`).join(""):`<li class="small">ê¸°ë¡ ì—†ìŒ</li>`;
    const ks=Object.keys(state.defeated);
    el.kill.innerHTML = ks.length? ks.map(k=>`<li>${k}: ${state.defeated[k]}ëª…</li>`).join(""):`<li class="small">ê¸°ë¡ ì—†ìŒ</li>`;
    saveMemorial(title);
    el.ending.style.display="flex"; el.endExit.disabled=true; setTimeout(()=>el.endExit.disabled=false,1500);
    el.endExit.onclick=()=>{ if(!el.endExit.disabled){ el.ending.style.display="none"; backToStart(true);} };
  }

  const checkDeath=()=>{ if(state.hp<=0){ state.ended=true; setBtns(false); el.after.style.display='none'; openEnding("ìˆœì§"); return true;} return false; };

  const logRankChange=(kind, prevIdx, nowIdx, servedPrev)=>{
    const R=RANKS, prev=R[prevIdx], now=R[nowIdx];
    const y=Math.floor(servedPrev/12), m=servedPrev%12;
    const when = (y>0 && m===0)? `${y}ë…„ ì°¨` : (y===0? `${m}ê°œì›” ì°¨`:`${y}ë…„ ${m}ê°œì›” ì°¨`);
    const icon=kind==='ìŠ¹ì§„'?'â¬†ï¸':'â¬‡ï¸';
    state.changeLog.push(`${icon} ${prev} ${when} ${now} ${kind}`);
  };

  function nextCostForRank(idx){
    if(idx===0) return 7;  // ì˜ê²½ -> ìˆœê²½
    if(idx===1) return 10; // ìˆœê²½ -> ê²½ì¥
    let cost = 10; // 1->2
    let curIdx = 1;
    while(curIdx < idx){
      const afterIdx = curIdx + 1;
      const mult = (afterIdx >= 6) ? 1.3 : 1.5; // ê²½ì •ë¶€í„° 1.3ë°°
      cost = Math.ceil(cost * mult);
      curIdx += 1;
    }
    return cost; // idx -> idx+1
  }

  function handleVictory(){
    if(state.hp<=0) return checkDeath();
    addDefeated();
    state.monthsAccum += (state.rankIdx>=2 && state.rankIdx<=6)?6:3;
    let text="";
    if(state.enemyHP<=-15){
      if(state.rankIdx===0){ state.ended=true; return openEnding("ì¶”ë°©"); }
      const before=totalMonths();
      const prevIdx=state.rankIdx;
      state.rankIdx-=1;
      state.cost = nextCostForRank(state.rankIdx); // ê°•ë“± í›„ ë¹„ìš© ì¬ê³„ì‚°
      const bonus=(state.rankIdx<=3?5:(state.rankIdx<=7?11:5));
      const servedPrev=(before+bonus)-state.rankStartMonths;
      logRankChange("ê°•ë“±", prevIdx, state.rankIdx, servedPrev);
      state.maxHP=Math.max(10,state.maxHP-10);
      state.hp=Math.min(state.hp,state.maxHP);
      state.bonusMonths+=bonus; state.rankStartMonths=before+bonus;
      updateHUD(); openPopup("â¬‡ï¸ ê°•ë“±",[`ê³„ê¸‰: ${RANKS[prevIdx]} â†’ ${RANKS[state.rankIdx]}`,`ìµœëŒ€ì²´ë ¥ -10`]);
      text="ì  ì‚¬ë§, ê°•ë“±!";
    }else if(state.enemyHP<=-10){
      text="ê³¼ì‰ì§„ì•• ë³´ìƒì—†ìŒ";
    }else{
      const earned=grantGold(); text=`ì ì„ ì œì••í–ˆë‹¤! +${earned} ê³¨ë“œ íšë“!`;
    }
    el.btnAmmo.textContent = state.ammo==='22lr' ? "ğŸ”„ ë‹¤ìŒ í„´ íƒ„ì¢…: 9mm" : "ğŸ”„ ë‹¤ìŒ í„´ íƒ„ì¢…: 22lr";
    el.msg.textContent=text; setBtns(false); el.after.style.display="block";
    if(state.level>=MAX_LEVEL){ state.ended=true; openEnding("ì •ë…„í‡´ì§"); }
    else{ state.level+=1; }
  }

  const rollAnim=(p,e)=>{
    el.pDice.classList.add("shake"); el.eDice.classList.add("shake");
    setTimeout(()=>{
      el.pDice.classList.remove("shake"); el.eDice.classList.remove("shake");
      el.pDice.textContent=DICE[p-1]; el.eDice.textContent=DICE[e-1];
    },300);
  };

  function handleEqualStreak(p,e){
    if(p===e){
      state.equalStreak += 1;
      if(state.equalStreak>=2){
        const bonus = 10;
        state.gold += bonus;
        updateHUD();
        openPopup("ğŸ¯ ì—°ì† ë™ì‹œ ì ì¤‘!", `ì ê³¼ ê°™ì€ ì£¼ì‚¬ìœ„ ${state.equalStreak}íšŒ ì—°ì†! ë³´ë„ˆìŠ¤ +${bonus} ê³¨ë“œ`);
        checkResignByWealth();
      }
    }else{
      state.equalStreak = 0;
    }
  }

  el.btnRoll.onclick=()=>{
    if(state.ended) return;
    setBtns(false);
    const p=rint(1,6), e=rint(1,6);
    rollAnim(p,e);
    setTimeout(()=>{
      state.enemyHP-=p; state.hp-=e; updateHUD(); handleEqualStreak(p,e);
      if(state.enemyHP<=0){ if(checkDeath()) return; handleVictory(); return; }
      if(checkDeath()) return;
      el.msg.textContent="âš”ï¸ ì œì•• ì¤‘...";
      setBtns(true);
    },300);
  };

  function fireStats(){
    return (state.ammo==='9mm') ? {cost:4, hit:0.45, min:35, max:45} : {cost:3, hit:0.50, min:20, max:25};
  }

  el.btnFire.onclick=()=>{
    if(state.ended) return;
    const st = fireStats();
    if(state.gold<st.cost){ el.msg.textContent="ğŸ’° ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!"; return; }
    state.gold-=st.cost; updateHUD();
    const ok=Math.random()<st.hit;
    setBtns(false);
    if(ok){
      const dmg=rint(st.min,st.max);
      el.msg.textContent=`ğŸ¯ ì ì¤‘! (-${dmg} ë°ë¯¸ì§€)`;
      setTimeout(()=>{
        state.enemyHP-=dmg; updateHUD();
        if(state.enemyHP<=0){ if(checkDeath()) return; handleVictory(); return; }
        const e=rint(1,6); el.pDice.textContent="â›”"; el.eDice.textContent=DICE[e-1];
        state.equalStreak=0;
        setTimeout(()=>{
          state.hp-=e; updateHUD(); if(checkDeath()) return;
          el.msg.textContent="ì ì˜ ë°˜ê²©! ë‚´ ì£¼ì‚¬ìœ„ëŠ” í•œ í„´ ë¬´ë ¥í™”ë˜ì—ˆìŠµë‹ˆë‹¤.";
          setBtns(true);
        },1000);
      },1000);
    }else{
      el.msg.textContent="âŒ ì‹¤íŒ¨!";
      setTimeout(()=>{
        const e=rint(1,6); el.pDice.textContent="â›”"; el.eDice.textContent=DICE[e-1];
        state.equalStreak=0;
        setTimeout(()=>{
          state.hp-=e; updateHUD(); if(checkDeath()) return;
          el.msg.textContent="ì ì˜ ë°˜ê²©! ë‚´ ì£¼ì‚¬ìœ„ëŠ” í•œ í„´ ë¬´ë ¥í™”ë˜ì—ˆìŠµë‹ˆë‹¤.";
          setBtns(true);
        },1000);
      },1000);
    }
  };

  el.btnAmmo.onclick=()=>{
    if(state.ammo==='22lr'){
      state.ammo='9mm';
      openPopup("ğŸ”„ íƒ„ì¢… ì „í™˜", "ë‹¤ìŒ í„´ë¶€í„° 9mmíƒ„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. (-4ğŸ’° / 45% / 35~45)");
    }else{
      state.ammo='22lr';
      openPopup("ğŸ”„ íƒ„ì¢… ì „í™˜", "ë‹¤ìŒ í„´ë¶€í„° 22lríƒ„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. (-3ğŸ’° / 50% / 20~25)");
    }
    updateFireLabel();
    el.btnAmmo.textContent = state.ammo==='22lr' ? "ğŸ”„ ë‹¤ìŒ í„´ íƒ„ì¢…: 9mm" : "ğŸ”„ ë‹¤ìŒ í„´ íƒ„ì¢…: 22lr";
  };

  el.btnRest.onclick=()=>{ if(state.ended) return; if(checkDeath()) return; state.hp=Math.min(state.maxHP,state.hp+5); updateHUD(); spawnEnemy(); };
  el.btnBuyBag.onclick=()=>{ if(state.ended) return; if(checkDeath()) return; if(state.gold>=5){ state.gold-=5; state.bags+=1; updateHUD(); } else{ el.msg.textContent="ğŸ’° ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!"; } };
  el.btnPromote.onclick=()=>{
    if(state.ended) return; if(checkDeath()) return;
    const TOP=RANKS.length-1; if(state.rankIdx>=TOP){ state.ended=true; return openEnding("ëª…ì˜ˆí‡´ì§-ì²­ì¥í‡´ì§"); }
    if(state.gold<state.cost){ el.msg.textContent="ğŸ’° ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!"; return; }
    const before=totalMonths(); const prevIdx=state.rankIdx; const prev=RANKS[prevIdx];
    state.gold-=state.cost; state.rankIdx+=1;
    state.cost = nextCostForRank(state.rankIdx); // ìŠ¹ì§„ í›„ ë‹¤ì‹œ ê³„ì‚°
    const bonus=(state.rankIdx<=3?5:(state.rankIdx<=7?11:5));
    const servedPrev=(before+bonus)-state.rankStartMonths;
    logRankChange("ìŠ¹ì§„", prevIdx, state.rankIdx, servedPrev);
    state.maxHP+=10; state.hp=Math.min(state.maxHP,state.hp+99);
    state.bonusMonths+=bonus; state.rankStartMonths=before+bonus;
    updateHUD(); openPopup("ğŸ–ï¸ ìŠ¹ì§„!",[`ê³„ê¸‰: ${prev} â†’ ${RANKS[state.rankIdx]}`,`ìµœëŒ€ì²´ë ¥ +10`]);
    checkResignByWealth();
  };
  el.btnUseBag.onclick=()=>{ if(state.ended) return; if(state.bags>0){ state.bags-=1; state.hp=Math.min(state.maxHP,state.hp+30); updateHUD(); } else{ el.msg.textContent="ğŸ’‰ êµ¬ê¸‰í•¨ì´ ì—†ìŠµë‹ˆë‹¤!"; } };

  const sel=(btn,on)=>btn.classList.toggle("selected",on);
  el.orgPolice.onclick=()=>{ state.org='police'; sel(el.orgPolice,true); sel(el.orgCoast,false); };
  el.orgCoast.onclick=()=>{ state.org='coast'; sel(el.orgCoast,true); sel(el.orgPolice,false); };
  el.genderM.onclick=()=>{ state.gender='M'; sel(el.genderM,true); sel(el.genderF,false); };
  el.genderF.onclick=()=>{ state.gender='F'; sel(el.genderF,true); sel(el.genderM,false); };
  el.rankStartA.onclick=()=>{ state.startRankIdx=1; sel(el.rankStartA,true); sel(el.rankStartB,false); };
  el.rankStartB.onclick=()=>{ state.startRankIdx=4; sel(el.rankStartB,true); sel(el.rankStartA,false); };

  function applyStartRank(){
    state.rankIdx = state.startRankIdx;
    state.entryRank = RANKS[state.startRankIdx];
    if(state.startRankIdx===4){ // ê²½ìœ„
      state.maxHP = 80; state.hp = 80; state.gold = 0;
      state.cost = nextCostForRank(4); // ê²½ìœ„ -> ê²½ê°
    }else{ // ìˆœê²½
      state.rankIdx = 1; state.entryRank = RANKS[1];
      state.maxHP = 50; state.hp = 50; state.gold = 0;
      state.cost = nextCostForRank(1); // 10
    }
    state.ammo='22lr';
    updateFireLabel();
  }

  function resetSelections(){
    [el.orgPolice, el.orgCoast, el.genderM, el.genderF, el.rankStartA, el.rankStartB].forEach(b=>b.classList.remove('selected'));
    $("nm").value="";
  }

  function backToStart(fromEnding=false){
    Object.assign(state, {
      org:null, gender:null, name:"â€”", startRankIdx:1, rankIdx:1, entryRank:"ìˆœê²½",
      level:1, maxHP:50, hp:50, gold:0, bags:0, enemyHP:0, enemyLabel:"", cost:10,
      ended:false, startDate:new Date(), defeated:{}, bonusMonths:0, rankStartMonths:0,
      changeLog:[], monthsAccum:0, finalGold:0, equalStreak:0, ammo:'22lr'
    });
    if(fromEnding){
      el.ending.style.display="none";
      el.start.style.display="flex";
      resetSelections();
      setBtns(true);
    }else{
      el.btnRestart.style.display="none"; setBtns(true); spawnEnemy();
    }
    updateHUD();
  }

  el.btnStart.onclick=()=>{
    if(!state.org) state.org=Math.random()<0.5?'police':'coast';
    if(!state.gender) state.gender=Math.random()<0.5?'M':'F';
    const nm=($("nm").value||"").trim();
    state.name = nm ? nm : (state.org==='police' ? (state.gender==='F'?'í¬ìˆœ':'í¬ëŒ') : (state.gender==='F'?'í•´ëˆ„ë¦¬':'í•´ìš°ë¦¬'));
    state.startDate = new Date();
    applyStartRank();
    el.start.style.display="none"; el.game.style.display="block"; setBtns(true); spawnEnemy(); updateHUD();
  };

  backToStart(false);
})();
</script>
</body>
</html>
